<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Luminosity Festival Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Free CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }
      .priority-btn-group .btn-selected {
        background-color: #4f46e5;
        color: white;
      }
      .add-btn.added {
        background-color: #10b981;
        color: white;
        width: 34px;
        height: 34px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        transition: all 0.2s;
      }
      .add-btn.added:hover {
        transform: scale(1.05);
      }
      .concert-item.selected {
        background-color: #d1fae5; /* emerald-100 */
      }
      .concert-item.selected:hover {
        background-color: #a7f3d0; /* emerald-200 */
      }
      .concert-item.selected-conflict {
        background-color: #fef3c7; /* amber-100 */
      }
      .concert-item.selected-conflict:hover {
        background-color: #fde68a; /* amber-200 */
      }

      /* --- Dark Mode Styles --- */
      .dark body {
        background-color: #111827;
        color: #d1d5db;
      }
      .dark .card {
        background-color: #1f2937;
        border-color: #374151;
      }
      .dark .text-indigo-600 {
        color: #818cf8;
      }
      .dark .text-gray-600 {
        color: #9ca3af;
      }
      .dark .text-gray-500 {
        color: #6b7280;
      }
      .dark .border-b {
        border-color: #374151;
      }
      .dark .concert-item:hover {
        background-color: #374151;
      }
      .dark .concert-item.selected {
        background-color: #064e3b;
      }
      .dark .concert-item.selected:hover {
        background-color: #047857;
      }
      .dark .concert-item.selected-conflict {
        background-color: #78350f;
      } /* amber-800 */
      .dark .concert-item.selected-conflict:hover {
        background-color: #92400e;
      } /* amber-900 */
      .dark .day-header,
      .dark .itinerary-day-header {
        background-color: #1f2937;
      }
      .dark .priority-btn {
        background-color: #374151;
        border-color: #4b5563;
        color: #d1d5db;
      }
      .dark .priority-btn.btn-selected {
        background-color: #6366f1;
        color: white;
      }
      .dark .bg-green-100 {
        background-color: #042f2e;
      }
      .dark .text-green-800 {
        color: #6ee7b7;
      }
      .dark .text-green-700 {
        color: #a7f3d0;
      }
      .dark .border-green-500 {
        border-color: #10b981;
      }
      .dark .bg-yellow-100 {
        background-color: #422006;
      }
      .dark .text-yellow-800 {
        color: #fcd34d;
      }
      .dark .text-yellow-700 {
        color: #fde68a;
      }
      .dark .border-yellow-500 {
        border-color: #f59e0b;
      }
      .dark .hover\:bg-yellow-200:hover {
        background-color: #78350f;
      }
      .dark .bg-gray-50 {
        background-color: #374151;
      }
      .dark input[type="text"],
      .dark input[type="checkbox"] {
        background-color: #1f2937;
        border-color: #4b5563;
      }
      .dark input[type="checkbox"]:checked {
        background-color: #4f46e5;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
      <header class="relative text-center mb-8">
        <h1 class="text-4xl sm:text-5xl font-bold text-indigo-600">
          Luminosity Beach Festival 2025
        </h1>
        <p class="mt-2 text-lg text-gray-600">Your Personal Concert Planner</p>
        <button
          id="theme-toggle"
          class="absolute top-0 right-0 p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none"
        >
          <i id="theme-icon-light" class="fa-solid fa-sun fa-lg"></i>
          <i id="theme-icon-dark" class="fa-solid fa-moon fa-lg hidden"></i>
        </button>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Concert Selection Column -->
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg card">
          <h2 class="text-2xl font-semibold mb-4 border-b pb-2">
            Select Your Concerts
          </h2>

          <!-- Filter Section -->
          <div
            id="filter-container"
            class="mb-6 p-4 border rounded-lg bg-gray-50"
          >
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label
                  for="artist-search"
                  class="block text-sm font-medium mb-1"
                  >Search Artist</label
                >
                <input
                  type="text"
                  id="artist-search"
                  placeholder="e.g. Ferry Corsten"
                  class="w-full p-2 border rounded-md"
                />
              </div>
              <div class="flex items-end">
                <button
                  id="reset-filters-btn"
                  class="w-full md:w-auto bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white"
                >
                  Reset Filters
                </button>
              </div>
            </div>
            <div class="mt-4">
              <h4 class="font-medium mb-2">Filter by Day</h4>
              <div id="day-filters" class="flex flex-wrap gap-x-4 gap-y-2">
                <!-- Day checkboxes will be injected here -->
              </div>
            </div>            <div class="mt-4">
              <h4 class="font-medium mb-2">Filter by Stage</h4>
              <div id="stage-filters" class="flex flex-wrap gap-x-4 gap-y-2">
                <!-- Stage checkboxes will be injected here -->
              </div>
            </div>
            <div class="mt-4">
              <h4 class="font-medium mb-2">Filter by Priority</h4>
              <div id="priority-filters" class="flex flex-wrap gap-x-4 gap-y-2">
                <!-- Priority checkboxes will be injected here -->
              </div>
            </div>
          </div>

          <div id="concert-list"></div>
        </div>

        <!-- Itinerary Column -->
        <div class="lg:col-span-1">
          <div class="sticky top-8 bg-white p-6 rounded-2xl shadow-lg card">            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">
              Your Itinerary
            </h2>
            <div id="itinerary-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
            <button
              id="clear-plan-btn"
              class="mt-6 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105 hidden"
            >
              Clear Plan
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      let concertData = [
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Mainstage Beach",
          startTime: "12:00",
          endTime: "13:00",
          artist: "Spark & Shade",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Mainstage Beach",
          startTime: "13:00",
          endTime: "14:00",
          artist: "Sønin",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Mainstage Beach",
          startTime: "14:00",
          endTime: "15:00",
          artist: "Nitrous Oxide",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Mainstage Beach",
          startTime: "15:00",
          endTime: "16:00",
          artist: "Simon O'Shine",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Mainstage Beach",
          startTime: "16:00",
          endTime: "17:00",
          artist: "Asteroid",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Mainstage Beach",
          startTime: "17:00",
          endTime: "18:00",
          artist: "Paul Denton",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Mainstage Beach",
          startTime: "18:00",
          endTime: "19:15",
          artist: "Jordan Suckley",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Mainstage Beach",
          startTime: "19:15",
          endTime: "20:30",
          artist: "Alti",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Mainstage Beach",
          startTime: "20:30",
          endTime: "21:45",
          artist: "Gareth Emery (Hard Set)",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Mainstage Beach",
          startTime: "21:45",
          endTime: "23:00",
          artist: "Mark Sherry",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Sunset Beach",
          startTime: "12:00",
          endTime: "13:15",
          artist: "Sinful Biz",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Sunset Beach",
          startTime: "13:15",
          endTime: "14:30",
          artist: "Darren Tate",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Sunset Beach",
          startTime: "14:30",
          endTime: "15:45",
          artist: "Ronski Speed",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Sunset Beach",
          startTime: "15:45",
          endTime: "17:00",
          artist: "Kyau & Albert",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Sunset Beach",
          startTime: "17:00",
          endTime: "18:00",
          artist: "Genix",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Sunset Beach",
          startTime: "18:00",
          endTime: "19:00",
          artist: "Liam Wilson",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Sunset Beach",
          startTime: "19:00",
          endTime: "20:00",
          artist: "Artento Divini",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Sunset Beach",
          startTime: "20:00",
          endTime: "21:00",
          artist: "Allen Watts",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Sunset Beach",
          startTime: "21:00",
          endTime: "22:00",
          artist: "Metta & Glyde",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Sunset Beach",
          startTime: "22:00",
          endTime: "23:00",
          artist: "Sam Jones",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Beachclub Bernies",
          startTime: "13:00",
          endTime: "14:30",
          artist: "Temple One",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Beachclub Bernies",
          startTime: "14:30",
          endTime: "15:45",
          artist: "Andrea Ribeca",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Beachclub Bernies",
          startTime: "15:45",
          endTime: "17:00",
          artist: "Daniel Kandi",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Beachclub Bernies",
          startTime: "17:00",
          endTime: "18:15",
          artist: "Steve Allen",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Beachclub Bernies",
          startTime: "18:15",
          endTime: "19:30",
          artist: "Ahmed Romel",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Beachclub Bernies",
          startTime: "19:30",
          endTime: "20:45",
          artist: "Ferry Tayle & Tonks Pres. Mirage (Vinyl Set)",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Beachclub Bernies",
          startTime: "20:45",
          endTime: "22:00",
          artist: "Cold Blue",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "Beachclub Bernies",
          startTime: "22:00",
          endTime: "23:00",
          artist: "Signum",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Mainstage Beach",
          startTime: "12:00",
          endTime: "13:00",
          artist: "Dylhen",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Mainstage Beach",
          startTime: "13:00",
          endTime: "14:00",
          artist: "Leena Punks",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Mainstage Beach",
          startTime: "14:00",
          endTime: "15:00",
          artist: "Push",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Mainstage Beach",
          startTime: "15:00",
          endTime: "16:00",
          artist: "Kai Tracid",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Mainstage Beach",
          startTime: "16:00",
          endTime: "17:00",
          artist: "Amber Broos",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Mainstage Beach",
          startTime: "17:00",
          endTime: "18:00",
          artist: "Billy Gillies",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Mainstage Beach",
          startTime: "18:00",
          endTime: "19:15",
          artist: "Space 92",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Mainstage Beach",
          startTime: "19:15",
          endTime: "20:30",
          artist: "Vini Vici",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Mainstage Beach",
          startTime: "20:30",
          endTime: "21:45",
          artist: "Ben Nicky Pres. Emotional Havoc",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Mainstage Beach",
          startTime: "21:45",
          endTime: "23:00",
          artist: "Maddix",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Sunset Beach",
          startTime: "12:00",
          endTime: "13:00",
          artist: "Simon Gregory",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Sunset Beach",
          startTime: "13:00",
          endTime: "14:30",
          artist: "Paul Skelton",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Sunset Beach",
          startTime: "14:00",
          endTime: "15:00",
          artist: "Factoria",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Sunset Beach",
          startTime: "15:00",
          endTime: "18:00",
          artist: "Andy Moor (Producer Set)",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Sunset Beach",
          startTime: "16:00",
          endTime: "17:00",
          artist: "Paul Webster",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Sunset Beach",
          startTime: "17:00",
          endTime: "18:00",
          artist: "Sander van Doorn",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Sunset Beach",
          startTime: "18:00",
          endTime: "19:00",
          artist: "Will Rees",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Sunset Beach",
          startTime: "19:00",
          endTime: "20:00",
          artist: "Greg Downey",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Sunset Beach",
          startTime: "20:00",
          endTime: "21:00",
          artist: "Sean Tyas",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Sunset Beach",
          startTime: "21:00",
          endTime: "23:00",
          artist: "John Askew B2B Simon Patterson",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Beachclub Bernies",
          startTime: "12:00",
          endTime: "13:00",
          artist: "Claus Backslash",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Beachclub Bernies",
          startTime: "13:00",
          endTime: "14:00",
          artist: "Ralphie B & Frank Waanders Pres. Collide1",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Beachclub Bernies",
          startTime: "14:00",
          endTime: "15:00",
          artist: "Dimension",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Beachclub Bernies",
          startTime: "15:00",
          endTime: "16:00",
          artist: "Misja Helsloot",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Beachclub Bernies",
          startTime: "16:00",
          endTime: "17:00",
          artist: "Stoneface & Terminal",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Beachclub Bernies",
          startTime: "17:00",
          endTime: "18:15",
          artist: "Johan Gielen",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Beachclub Bernies",
          startTime: "18:15",
          endTime: "19:30",
          artist: "Maria Healy",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Beachclub Bernies",
          startTime: "19:30",
          endTime: "20:45",
          artist: "Richard Durand",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Beachclub Bernies",
          startTime: "20:45",
          endTime: "22:00",
          artist: "Snejder",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "Beachclub Bernies",
          startTime: "22:00",
          endTime: "23:00",
          artist: "RAM",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "This Is Trance!",
          startTime: "13:00",
          endTime: "14:15",
          artist: "Fuenka",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "This Is Trance!",
          startTime: "14:15",
          endTime: "15:30",
          artist: "Digital Drift",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "This Is Trance!",
          startTime: "15:30",
          endTime: "16:45",
          artist: "45C-Systems",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "This Is Trance!",
          startTime: "16:45",
          endTime: "18:00",
          artist: "Darren Porter",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "This Is Trance!",
          startTime: "18:00",
          endTime: "19:15",
          artist: "Adam Ellis",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "This Is Trance!",
          startTime: "19:15",
          endTime: "20:30",
          artist: "Kinetica",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "This Is Trance!",
          startTime: "20:30",
          endTime: "21:45",
          artist: "Toyax",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "This Is Trance!",
          startTime: "21:45",
          endTime: "23:00",
          artist: "Edele Andaya",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Mainstage Beach",
          startTime: "12:00",
          endTime: "13:15",
          artist: "Miromar",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Mainstage Beach",
          startTime: "13:15",
          endTime: "14:30",
          artist: "Estiva",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Mainstage Beach",
          startTime: "14:30",
          endTime: "15:45",
          artist: "Dosem",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Mainstage Beach",
          startTime: "15:45",
          endTime: "17:00",
          artist: "Daxson",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Mainstage Beach",
          startTime: "17:00",
          endTime: "18:30",
          artist: "Markus Schulz",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Mainstage Beach",
          startTime: "18:30",
          endTime: "20:00",
          artist: "John O'callaghan",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Mainstage Beach",
          startTime: "20:00",
          endTime: "21:30",
          artist: "Paul van Dyk",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Mainstage Beach",
          startTime: "21:30",
          endTime: "23:00",
          artist: "Bryan Kearney",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Sunset Beach",
          startTime: "12:00",
          endTime: "13:00",
          artist: "The Blizzard",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Sunset Beach",
          startTime: "13:00",
          endTime: "14:15",
          artist: "Trance Wax",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Sunset Beach",
          startTime: "14:15",
          endTime: "15:30",
          artist: "Push",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Sunset Beach",
          startTime: "16:45",
          endTime: "18:00",
          artist: "Gabriel & Dresden",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Sunset Beach",
          startTime: "16:45",
          endTime: "18:00",
          artist: "Ruben de Ronde Pres. NRG2000",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Sunset Beach",
          startTime: "16:45",
          endTime: "18:00",
          artist: "Superstrings",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Sunset Beach",
          startTime: "19:10",
          endTime: "20:20",
          artist: "Sander van Doorn",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Sunset Beach",
          startTime: "20:20",
          endTime: "21:30",
          artist: "Marcov",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Sunset Beach",
          startTime: "21:30",
          endTime: "23:00",
          artist: "Scot Project & Jordan Suckley",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Beachclub Bernies",
          startTime: "12:00",
          endTime: "13:15",
          artist: "Talee",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Beachclub Bernies",
          startTime: "13:15",
          endTime: "14:30",
          artist: "Modea",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Beachclub Bernies",
          startTime: "14:30",
          endTime: "15:45",
          artist: "Corren Cavini",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Beachclub Bernies",
          startTime: "15:45",
          endTime: "17:00",
          artist: "BLR",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Beachclub Bernies",
          startTime: "17:00",
          endTime: "19:00",
          artist: "Paul Oakenfold",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Beachclub Bernies",
          startTime: "19:00",
          endTime: "20:20",
          artist: "John 00 Fleming",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Beachclub Bernies",
          startTime: "20:20",
          endTime: "21:40",
          artist: "David Forbes",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "Beachclub Bernies",
          startTime: "21:40",
          endTime: "23:00",
          artist: "Mark Sherry Pres. Dark Sherry",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "This Is Trance!",
          startTime: "12:00",
          endTime: "13:30",
          artist: "Odette Hayas",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "This Is Trance!",
          startTime: "13:30",
          endTime: "15:00",
          artist: "Sunny Lax",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "This Is Trance!",
          startTime: "15:00",
          endTime: "16:20",
          artist: "The Blizzard",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "This Is Trance!",
          startTime: "16:20",
          endTime: "17:40",
          artist: "Daniel Skyver",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "This Is Trance!",
          startTime: "17:40",
          endTime: "19:00",
          artist: "Aeon Shift",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "This Is Trance!",
          startTime: "19:00",
          endTime: "20:20",
          artist: "DNA",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "This Is Trance!",
          startTime: "20:20",
          endTime: "21:40",
          artist: "Brendan Bartels",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "This Is Trance!",
          startTime: "21:40",
          endTime: "23:00",
          artist: "Renegade System",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Mainstage Beach",
          startTime: "12:00",
          endTime: "13:15",
          artist: "Alex Wright",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Mainstage Beach",
          startTime: "13:15",
          endTime: "14:30",
          artist: "Orkidea",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Mainstage Beach",
          startTime: "14:30",
          endTime: "15:45",
          artist: "The Thrillseekers",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Mainstage Beach",
          startTime: "15:45",
          endTime: "17:00",
          artist: "Craig Connelly",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Mainstage Beach",
          startTime: "17:00",
          endTime: "18:15",
          artist: "Ben Gold",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Mainstage Beach",
          startTime: "18:15",
          endTime: "19:45",
          artist: "Giuseppe Ottaviani B2B Nifra",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Mainstage Beach",
          startTime: "19:45",
          endTime: "21:15",
          artist: "Aly & Fila",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Mainstage Beach",
          startTime: "21:15",
          endTime: "23:00",
          artist: "Ferry Corsten",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Sunset Ravers",
          startTime: "12:00",
          endTime: "13:00",
          artist: "Jamie Walker",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Sunset Ravers",
          startTime: "13:00",
          endTime: "14:00",
          artist: "Tyler Jack",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Sunset Ravers",
          startTime: "14:00",
          endTime: "15:00",
          artist: "Symmetrik",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Sunset Ravers",
          startTime: "15:00",
          endTime: "16:00",
          artist: "Shugz",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Sunset Ravers",
          startTime: "16:00",
          endTime: "17:00",
          artist: "Ve/Ra",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Sunset Ravers",
          startTime: "17:00",
          endTime: "18:20",
          artist: "Mauro Picotto",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Sunset Ravers",
          startTime: "18:20",
          endTime: "19:40",
          artist: "Will Atkinson",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Sunset Ravers",
          startTime: "19:40",
          endTime: "21:00",
          artist: "Hannah Laing",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Sunset Ravers",
          startTime: "21:00",
          endTime: "22:00",
          artist: "The Rocketman",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Sunset Ravers",
          startTime: "22:00",
          endTime: "23:00",
          artist: "John Askew (Nothing But Rockets Set)",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "12:00",
          endTime: "13:00",
          artist: "Daniel Skyver (Progressive Classics)",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "12:00",
          endTime: "13:00",
          artist: "Sam Mitcham (Vinyl Set)",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "14:00",
          endTime: "15:00",
          artist: "Ben Lost",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "15:00",
          endTime: "16:00",
          artist: "Oliver Lieb",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "16:00",
          endTime: "17:00",
          artist: "Mr Sam",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "17:00",
          endTime: "18:00",
          artist: "Matt Darey",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "18:00",
          endTime: "19:00",
          artist: "The Space Brothers",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "19:00",
          endTime: "20:00",
          artist: "Judge Jules",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "20:00",
          endTime: "21:00",
          artist: "Fred Baker",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "21:00",
          endTime: "22:00",
          artist: "DJ Quicksilver",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "Beachclub Bernies",
          startTime: "22:00",
          endTime: "23:00",
          artist: "Factor B (Back To The Future Set)",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "This Is Trance!",
          startTime: "13:00",
          endTime: "14:15",
          artist: "Maywave",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "This Is Trance!",
          startTime: "14:15",
          endTime: "15:30",
          artist: "Peter Steele",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "This Is Trance!",
          startTime: "15:30",
          endTime: "16:45",
          artist: "Doppenberg",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "This Is Trance!",
          startTime: "16:45",
          endTime: "18:00",
          artist: "Enigma State",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "This Is Trance!",
          startTime: "18:00",
          endTime: "19:15",
          artist: "Ogravity",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "This Is Trance!",
          startTime: "19:15",
          endTime: "20:30",
          artist: "Tasso",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "This Is Trance!",
          startTime: "20:30",
          endTime: "21:45",
          artist: "Matt Bukovski",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "This Is Trance!",
          startTime: "21:45",
          endTime: "23:00",
          artist: "Νιkolauss",
        },
      ]; // --- DATA PRE-PROCESSING ---
      // Add a unique ID to each concert and consolidate stages
      concertData = concertData.map((concert, index) => {
        let stage = concert.stage;

        return {
          ...concert,
          id: `concert-${index}`, // Assign a stable, unique ID
          stage: stage,
        };
      });

      document.addEventListener("DOMContentLoaded", () => {
        // --- Elements ---
        const concertListContainer = document.getElementById("concert-list");
        const itineraryListContainer =
          document.getElementById("itinerary-list");
        const clearPlanBtn = document.getElementById("clear-plan-btn");
        const themeToggleBtn = document.getElementById("theme-toggle");
        const lightIcon = document.getElementById("theme-icon-light");
        const darkIcon = document.getElementById("theme-icon-dark");
        const htmlEl = document.documentElement;

        let userSelections = [];
        let winnerIds = new Set();

        // --- Theme Management ---
        const applyTheme = (theme) => {
          htmlEl.classList.toggle("dark", theme === "dark");
          darkIcon.classList.toggle("hidden", theme !== "dark");
          lightIcon.classList.toggle("hidden", theme === "dark");
        };
        const toggleTheme = () => {
          const newTheme = htmlEl.classList.contains("dark") ? "light" : "dark";
          localStorage.setItem("theme", newTheme);
          applyTheme(newTheme);
        };        // --- LocalStorage ---
        const saveSelections = () => {
          localStorage.setItem(
            "festivalPlannerSelections",
            JSON.stringify(userSelections)
          );
          // Dispatch event so other components can react to selection changes
          document.dispatchEvent(new CustomEvent('selectionsUpdated'));
        };
        const loadSelections = () => {
          const savedData = localStorage.getItem("festivalPlannerSelections");
          if (savedData) userSelections = JSON.parse(savedData);
        };

        // --- Helpers ---
        const timeToMinutes = (time) => {
          const [hours, minutes] = time.split(":").map(Number);
          return hours * 60 + minutes;
        };
        const getDuration = (start, end) =>
          timeToMinutes(end) - timeToMinutes(start);        const checkConflict = (concertA, concertB) => {
          if (!concertA || !concertB) return false;
          
          // Only check for conflicts if concerts are on the same day
          if (concertA.date !== concertB.date) return false;
          
          const startA = timeToMinutes(concertA.startTime);
          const endA = timeToMinutes(concertA.endTime);
          const startB = timeToMinutes(concertB.startTime);
          const endB = timeToMinutes(concertB.endTime);
          const overlap = Math.max(
            0,
            Math.min(endA, endB) - Math.max(startA, startB)
          );
          return overlap > 15;
        };

        // --- Main UI Refresh Logic ---
        const refreshAll = () => {
          updateWinners();
          applyFiltersAndRender();
          updateItinerary();
          saveSelections();
        };

        // --- Data Processing & Filtering ---
        const updateWinners = () => {
          const sortedSelections = [...userSelections].sort((a, b) => {
            if (a.priority !== b.priority) return a.priority - b.priority;
            return timeToMinutes(a.startTime) - timeToMinutes(b.startTime);
          });

          const winners = [];
          sortedSelections.forEach((concert) => {
            if (!winners.some((winner) => checkConflict(concert, winner))) {
              winners.push(concert);
            }
          });
          winnerIds = new Set(winners.map((w) => w.id));
        };

        const getUniqueValues = (key) =>
          [...new Set(concertData.map((item) => item[key]))].sort();        const applyFiltersAndRender = () => {
          const artistSearch = document
            .getElementById("artist-search")
            .value.toLowerCase();
          const selectedDays = [
            ...document.querySelectorAll("#day-filters input:checked"),
          ].map((el) => el.value);
          const selectedStages = [
            ...document.querySelectorAll("#stage-filters input:checked"),
          ].map((el) => el.value);          const selectedPriorityInputs = [
            ...document.querySelectorAll("#priority-filters input:checked"),
          ];
          
          // Separate numeric priorities from "not-selected" special case
          const selectedPriorities = selectedPriorityInputs
            .filter(el => el.value !== notSelectedValue)
            .map(el => parseInt(el.value, 10));
            
          const isNotSelectedChecked = selectedPriorityInputs.some(el => el.value === notSelectedValue);

          const filteredConcerts = concertData.filter((concert) => {
            const artistMatch = concert.artist
              .toLowerCase()
              .includes(artistSearch);
            const dayMatch =
              selectedDays.length === 0 || selectedDays.includes(concert.day);
            const stageMatch =
              selectedStages.length === 0 ||
              selectedStages.includes(concert.stage);
              
            // Check if this concert is in userSelections
            const existingSelection = userSelections.find(s => s.id === concert.id);
            const isSelected = !!existingSelection;
            
            // For priority, handle both numeric priorities and the "not selected" case
            let priorityMatch = selectedPriorityInputs.length === 0; // If no filters selected, match all
            
            if (!priorityMatch) {
              if (isNotSelectedChecked && !isSelected) {
                // If "Not selected" is checked and this concert isn't selected, it's a match
                priorityMatch = true;              } else if (selectedPriorities.length > 0 && isSelected) {
                // If numeric priorities are selected and this concert has one of those priorities
                priorityMatch = selectedPriorities.includes(existingSelection.priority);
              }
            }
            
            return artistMatch && dayMatch && stageMatch && priorityMatch;
              
            return artistMatch && dayMatch && stageMatch && priorityMatch;
          });

          renderFilteredConcerts(filteredConcerts);
        };

        // --- Render Functions ---
        const renderFilteredConcerts = (concertsToRender) => {
          concertListContainer.innerHTML = "";
          if (concertsToRender.length === 0) {
            concertListContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">No concerts match your filters.</p>`;
            return;
          }

          const checkMarkSVG = `<i class="fa-solid fa-check"></i>`;

          const concertsByDay = concertsToRender.reduce((acc, concert) => {
            (acc[concert.day] = acc[concert.day] || []).push(concert);
            return acc;
          }, {});

          Object.keys(concertsByDay)
            .sort(
              (a, b) =>
                ["Thursday", "Friday", "Saturday", "Sunday"].indexOf(a) -
                ["Thursday", "Friday", "Saturday", "Sunday"].indexOf(b)
            )
            .forEach((day) => {
              const dayHeader = document.createElement("h3");
              dayHeader.className =
                "day-header text-xl font-bold mt-6 mb-3 bg-gray-200 p-2 rounded-md";
              dayHeader.textContent = `${day}, ${concertsByDay[day][0].date}`;
              concertListContainer.appendChild(dayHeader);

              concertsByDay[day].forEach((concert) => {
                const concertEl = document.createElement("div");
                concertEl.className =
                  "concert-item flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 border-b hover:bg-gray-50";
                const existingSelection = userSelections.find(
                  (s) => s.id === concert.id
                );
                const isAdded = !!existingSelection;

                concertEl.classList.remove("selected", "selected-conflict");
                if (isAdded) {
                  if (winnerIds.has(concert.id)) {
                    concertEl.classList.add("selected");
                  } else {
                    concertEl.classList.add("selected-conflict");
                  }
                }

                const buttonContent = isAdded ? checkMarkSVG : "Add";
                const buttonClasses = isAdded
                  ? "add-btn added"
                  : "add-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-4 rounded-md";

                concertEl.innerHTML = `
                            <div class="flex-grow mb-2 sm:mb-0">
                                <p class="font-semibold text-lg">${
                                  concert.artist
                                }</p>
                                <p class="text-sm text-gray-600">${
                                  concert.startTime
                                } - ${concert.endTime} (${getDuration(
                  concert.startTime,
                  concert.endTime
                )} mins)</p>                                <p class="text-sm text-indigo-500 font-medium">${
                  concert.stage
                }</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="priority-btn-group flex" data-id="${
                                  concert.id
                                }">
                                    <button class="priority-btn text-xs font-semibold py-1 px-3 rounded-l-md border border-gray-300 bg-white" data-priority="1">P1</button><button class="priority-btn text-xs font-semibold py-1 px-3 border-t border-b border-gray-300 bg-white" data-priority="2">P2</button><button class="priority-btn text-xs font-semibold py-1 px-3 rounded-r-md border border-gray-300 bg-white" data-priority="3">P3</button>
                                </div>
                                <button class="${buttonClasses}" data-id="${
                  concert.id
                }">${buttonContent}</button>
                            </div>`;
                concertListContainer.appendChild(concertEl);
                if (isAdded) {
                  const priorityButton = concertEl.querySelector(
                    `.priority-btn[data-priority="${existingSelection.priority}"]`
                  );
                  if (priorityButton)
                    priorityButton.classList.add("btn-selected");
                }
              });
            });
        };

        const updateItinerary = () => {
          if (userSelections.length === 0) {
            itineraryListContainer.innerHTML =
              '<p class="text-gray-500">Your planned concerts will appear here. Add concerts from the left to get started!</p>';
            clearPlanBtn.classList.add("hidden");
            return;
          }

          clearPlanBtn.classList.remove("hidden");

          const winners = [...userSelections].filter((s) =>
            winnerIds.has(s.id)
          );
          const itineraryByDay = {};          winners
            .sort(
              (a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime)
            )
            .forEach((winner) => {
              const day = winner.day;
              if (!itineraryByDay[day]) itineraryByDay[day] = [];
              
              // Get conflicts and sort them by start time first, then by priority
              const conflicts = userSelections
                .filter(c => c.id !== winner.id && checkConflict(c, winner))
                .sort((a, b) => {
                  // First sort by start time
                  const timeCompare = timeToMinutes(a.startTime) - timeToMinutes(b.startTime);
                  // If start times are equal, sort by priority (lower priority number comes first)
                  return timeCompare !== 0 ? timeCompare : a.priority - b.priority;
                });
                
              itineraryByDay[day].push({
                concert: winner,
                conflicts: conflicts,
              });
            });

          renderItineraryUI(itineraryByDay);
        };

        const renderItineraryUI = (itineraryByDay) => {
          itineraryListContainer.innerHTML = "";
          const removeIconSVG = `<i class="fa-solid fa-xmark"></i>`;

          if (
            Object.keys(itineraryByDay).length === 0 &&
            userSelections.length > 0
          ) {
            itineraryListContainer.innerHTML =
              '<p class="text-gray-500 font-semibold">All your selections might have conflicts. Try changing priorities.</p>';
            return;
          } else if (userSelections.length === 0) {
            itineraryListContainer.innerHTML =
              '<p class="text-gray-500">Your planned concerts will appear here. Add concerts from the left to get started!</p>';
            return;
          }

          Object.keys(itineraryByDay)
            .sort(
              (a, b) =>
                ["Thursday", "Friday", "Saturday", "Sunday"].indexOf(a) -
                ["Thursday", "Friday", "Saturday", "Sunday"].indexOf(b)
            )
            .forEach((day) => {
              const dayHeader = document.createElement("h3");
              dayHeader.className =
                "itinerary-day-header text-lg font-bold mt-4 mb-2 bg-gray-200 p-2 rounded-md";
              dayHeader.textContent = day;
              itineraryListContainer.appendChild(dayHeader);

              itineraryByDay[day].forEach((item) => {
                const { concert, conflicts } = item;
                const itemEl = document.createElement("div");
                itemEl.className = "itinerary-item mb-2";

                itemEl.innerHTML = `
                            <div class="p-3 bg-green-100 border-l-4 border-green-500 rounded-r-lg">
                                <div class="flex justify-between items-start">
                                    <div class="concert-swap-item cursor-pointer flex-grow" data-main-id="${
                                      concert.id
                                    }" data-conflict-id="${concert.id}">
                                        <p class="font-bold text-green-800">${
                                          concert.artist
                                        } (P${concert.priority})</p>
                                        <p class="text-sm text-green-700">${
                                          concert.startTime
                                        } - ${concert.endTime} (${getDuration(
                  concert.startTime,
                  concert.endTime
                )} mins)</p>                                        <p class="text-sm text-green-700 font-medium">@ ${
                  concert.stage
                }</p>
                                    </div>
                                    <button title="Remove concert" class="remove-item-btn p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-100 dark:text-gray-500 dark:hover:text-red-400 dark:hover:bg-gray-700" data-id="${
                                      concert.id
                                    }">
                                        ${removeIconSVG}
                                    </button>
                                </div>
                            </div>
                            <div class="conflict-container pl-5" id="conflict-list-${
                              concert.id
                            }"></div>
                        `;
                itineraryListContainer.appendChild(itemEl);

                if (conflicts.length > 0) {
                  const conflictContainer = itemEl.querySelector(
                    `#conflict-list-${concert.id}`
                  );
                  populateConflictList(
                    conflictContainer,
                    conflicts,
                    concert.id
                  );
                }
              });
            });
        };

        const populateConflictList = (container, conflicts, mainConcertId) => {
          const removeIconSVG = `<i class="fa-solid fa-xmark"></i>`;
          container.innerHTML = "";
          conflicts.forEach((conflict) => {
            const conflictEl = document.createElement("div");
            conflictEl.className =
              "p-3 mt-2 bg-yellow-100 border-l-4 border-yellow-500 rounded-r-lg";

            conflictEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="conflict-swap-item cursor-pointer flex-grow" data-main-id="${mainConcertId}" data-conflict-id="${conflict.id}">
                                <p class="font-bold text-yellow-800">${conflict.artist} (P${conflict.priority})</p>
                                <p class="text-sm text-yellow-700">${conflict.startTime} - ${conflict.endTime} @ ${conflict.stage}</p>
                                <p class="text-sm text-yellow-700">Click to swap</p>
                            </div>
                            <button title="Remove conflict" class="remove-conflict-btn p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-100 dark:text-gray-500 dark:hover:text-red-400 dark:hover:bg-gray-700" data-id="${conflict.id}">
                                ${removeIconSVG}
                            </button>
                        </div>
                    `;
            container.appendChild(conflictEl);
          });
        };

        // --- Event Handlers ---
        const handleAddClick = (e) => {
          const button = e.target.closest(".add-btn");
          if (!button) return;

          const concertId = button.dataset.id;
          const concert = concertData.find((c) => c.id === concertId);
          const existingSelectionIndex = userSelections.findIndex(
            (s) => s.id === concertId
          );          if (existingSelectionIndex > -1) {
            userSelections.splice(existingSelectionIndex, 1);
          } else {
            const concertElement = button.closest(".concert-item");
            const selectedPriorityBtn = concertElement.querySelector(
              ".priority-btn-group .btn-selected"
            );
            
            // Add the concert with priority 1 as default (will be adjusted by recalculation)
            const newConcert = { 
              ...concert, 
              priority: 1 
            };
            userSelections.push(newConcert);
            
            // If a priority button was manually selected, force that priority
            if (selectedPriorityBtn) {
              const forcedPriority = parseInt(
                selectedPriorityBtn.dataset.priority,
                10
              );
              
              // Force the priority for the newly added concert
              recalculatePriorities({
                [newConcert.id]: forcedPriority
              });
            } else {
              // No forced priority, just recalculate all based on conflicts
              recalculatePriorities();
            }
          }
          refreshAll();
        };        // Recalculate priorities for all concerts based on conflicts
        const recalculatePriorities = (forcedPriorities = {}) => {
          // Create a copy of the selections for processing
          const concertsToProcess = userSelections.map(c => ({
            ...c,
            // Apply forced priorities or keep existing priority
            priority: forcedPriorities[c.id] || c.priority
          }));
          
          // Sort concerts by their priority (P1 first)
          concertsToProcess.sort((a, b) => a.priority - b.priority);
          
          // Build a graph of conflicts for each concert
          const conflictGraph = {};
          concertsToProcess.forEach(concert => {
            conflictGraph[concert.id] = concertsToProcess
              .filter(c => c.id !== concert.id && checkConflict(c, concert))
              .map(c => c.id);
          });
          
          // Process each concert and resolve conflicts
          concertsToProcess.forEach(concert => {
            const conflicts = conflictGraph[concert.id];
            
            // If this concert has a forced priority, adjust conflicting concerts
            if (forcedPriorities[concert.id]) {
              const forcedPriority = forcedPriorities[concert.id];
              
              conflicts.forEach(conflictId => {
                const conflictConcert = concertsToProcess.find(c => c.id === conflictId);
                if (conflictConcert && conflictConcert.priority <= forcedPriority) {
                  // Only bump priority if not already forced
                  if (!forcedPriorities[conflictId]) {
                    // If forced P1, conflict becomes P2; if forced P2, conflict becomes P3
                    conflictConcert.priority = Math.min(3, forcedPriority + 1);
                  }
                }
              });
            } 
            // Otherwise, try to get the highest priority possible
            else {
              // Get priorities of all conflicts
              const conflictPriorities = conflicts.map(id => 
                concertsToProcess.find(c => c.id === id).priority
              );
              
              // If no conflicts, can be P1
              if (conflictPriorities.length === 0) {
                concert.priority = 1;
              }
              // Otherwise, find the lowest usable priority
              else {
                // Try P1 first
                if (!conflictPriorities.includes(1)) {
                  concert.priority = 1;
                } 
                // Then try P2
                else if (!conflictPriorities.includes(2)) {
                  concert.priority = 2;
                }
                // Default to P3 if necessary
                else {
                  concert.priority = 3;
                }
              }
            }
          });
          
          // Update the original selections with new priorities
          concertsToProcess.forEach(processed => {
            const selection = userSelections.find(s => s.id === processed.id);
            if (selection) {
              selection.priority = processed.priority;
            }
          });
        };

        const handlePriorityClick = (e) => {
          const button = e.target.closest(".priority-btn");
          if (!button) return;

          const priorityGroup = button.parentElement;
          const concertId = priorityGroup.dataset.id;
          const newPriority = parseInt(button.dataset.priority, 10);

          const selectionIndex = userSelections.findIndex(
            (s) => s.id === concertId
          );

          if (selectionIndex > -1) {
            // Force this concert's priority to the selected value
            const forcedPriorities = {
              [concertId]: newPriority
            };            // Recalculate all priorities with this constraint
            recalculatePriorities(forcedPriorities);
            
            // Refresh the UI once with the updated priorities
            refreshAll();
          } else {
            const allPriorityButtons =
              priorityGroup.querySelectorAll(".priority-btn");
            allPriorityButtons.forEach((btn) =>
              btn.classList.remove("btn-selected")
            );
            button.classList.add("btn-selected");
          }
        };

        const handleRemoveItem = (concertIdToRemove) => {
          const indexToRemove = userSelections.findIndex(
            (c) => c.id === concertIdToRemove
          );
          if (indexToRemove > -1) {
            userSelections.splice(indexToRemove, 1);
            refreshAll();
          }
        };

        const handleItineraryClick = (e) => {
          const removeItemBtn = e.target.closest(".remove-item-btn");
          if (removeItemBtn) {
            handleRemoveItem(removeItemBtn.dataset.id);
            return;
          }

          const removeConflictBtn = e.target.closest(".remove-conflict-btn");
          if (removeConflictBtn) {
            handleRemoveItem(removeConflictBtn.dataset.id);
            return;
          }

          const swapItem = e.target.closest(".conflict-swap-item");
          if (swapItem) {
            const mainId = swapItem.dataset.mainId;
            const conflictId = swapItem.dataset.conflictId;
            const mainConcertIndex = userSelections.findIndex(
              (c) => c.id === mainId
            );
            const conflictConcertIndex = userSelections.findIndex(
              (c) => c.id === conflictId
            );

            if (mainConcertIndex > -1 && conflictConcertIndex > -1) {
              const mainPriority = userSelections[mainConcertIndex].priority;
              userSelections[mainConcertIndex].priority =
                userSelections[conflictConcertIndex].priority;
              userSelections[conflictConcertIndex].priority = mainPriority;
              refreshAll();
            }
            return;
          }
        };

        const clearPlan = () => {
          userSelections = [];
          refreshAll();
        };        const initializeFilters = () => {
          const dayFilterContainer = document.getElementById("day-filters");
          const stageFilterContainer = document.getElementById("stage-filters");
          const priorityFilterContainer = document.getElementById("priority-filters");
          const artistSearchInput = document.getElementById("artist-search");
          const resetBtn = document.getElementById("reset-filters-btn");

          const dayOrder = ["Thursday", "Friday", "Saturday", "Sunday"];          const uniqueDays = getUniqueValues("day").sort(
            (a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b)
          );
          const uniqueStages = getUniqueValues("stage");
          const priorities = [1, 2, 3];
          const notSelectedValue = "not-selected";

          uniqueDays.forEach((day) => {
            const checkboxDiv = document.createElement("div");
            checkboxDiv.className = "flex items-center";
            checkboxDiv.innerHTML = `<input id="day-${day}" value="${day}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="day-${day}" class="ml-2">${day}</label>`;
            dayFilterContainer.appendChild(checkboxDiv);
          });          uniqueStages.forEach((stage) => {
            const checkboxDiv = document.createElement("div");
            checkboxDiv.className = "flex items-center";
            checkboxDiv.innerHTML = `<input id="stage-${stage}" value="${stage}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="stage-${stage}" class="ml-2">${stage}</label>`;
            stageFilterContainer.appendChild(checkboxDiv);
          });
            // Add priority filters
          priorities.forEach((priority) => {
            const checkboxDiv = document.createElement("div");
            checkboxDiv.className = "flex items-center";
            checkboxDiv.innerHTML = `<input id="priority-${priority}" value="${priority}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="priority-${priority}" class="ml-2">P${priority}</label>`;
            priorityFilterContainer.appendChild(checkboxDiv);
          });
          
          // Add the "Not selected" checkbox
          const notSelectedDiv = document.createElement("div");
          notSelectedDiv.className = "flex items-center";
          notSelectedDiv.innerHTML = `<input id="priority-${notSelectedValue}" value="${notSelectedValue}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="priority-${notSelectedValue}" class="ml-2">Not selected</label>`;
          priorityFilterContainer.appendChild(notSelectedDiv);

          artistSearchInput.addEventListener("input", applyFiltersAndRender);
          dayFilterContainer.addEventListener("change", applyFiltersAndRender);
          stageFilterContainer.addEventListener(
            "change",
            applyFiltersAndRender
          );
          priorityFilterContainer.addEventListener(
            "change",
            applyFiltersAndRender
          );          resetBtn.addEventListener("click", () => {
            artistSearchInput.value = "";
            document
              .querySelectorAll('#filter-container input[type="checkbox"]')
              .forEach((cb) => (cb.checked = false));
            applyFiltersAndRender();
          });          // Always show priority filter section and update styling
          const updatePriorityFilterVisibility = () => {
            const priorityFilterSection = priorityFilterContainer.closest('div.mt-4');
            priorityFilterSection.style.display = 'block';
            
            // Update the priority checkboxes to show counts
            priorities.forEach(priority => {
              const checkbox = document.getElementById(`priority-${priority}`);
              const label = checkbox.nextElementSibling;
              const count = userSelections.filter(s => s.priority === priority).length;
              
              if (count > 0) {
                label.innerHTML = `P${priority} <span class="ml-1 px-2 py-0.5 text-xs bg-indigo-100 text-indigo-800 rounded-full">${count}</span>`;
              } else {
                label.innerHTML = `P${priority}`;
              }
            });
            
            // Update the "Not selected" checkbox to show count
            const notSelectedCheckbox = document.getElementById(`priority-${notSelectedValue}`);
            const notSelectedLabel = notSelectedCheckbox.nextElementSibling;
            const notSelectedCount = concertData.length - userSelections.length;
            
            if (notSelectedCount > 0) {
              notSelectedLabel.innerHTML = `Not selected <span class="ml-1 px-2 py-0.5 text-xs bg-gray-100 text-gray-700 rounded-full">${notSelectedCount}</span>`;
            } else {
              notSelectedLabel.innerHTML = 'Not selected';
            }
          };
            // Initial call to set visibility
          updatePriorityFilterVisibility();
          
          // Update visibility whenever selections change or after filter reset
          document.addEventListener('selectionsUpdated', updatePriorityFilterVisibility);
          resetBtn.addEventListener('click', () => setTimeout(updatePriorityFilterVisibility, 50));
        };

        // --- Initialisation ---
        const initialTheme =
          localStorage.getItem("theme") ||
          (window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light");
        applyTheme(initialTheme);
        loadSelections();
        initializeFilters();
        refreshAll();

        // --- Event Listeners ---
        themeToggleBtn.addEventListener("click", toggleTheme);
        const concertListElement = document.getElementById("concert-list");
        concertListElement.addEventListener("click", (e) => {
          if (e.target.closest(".add-btn")) {
            handleAddClick(e);
          } else if (e.target.closest(".priority-btn")) {
            handlePriorityClick(e);
          }
        });
        itineraryListContainer.addEventListener("click", handleItineraryClick);
        clearPlanBtn.addEventListener("click", clearPlan);
      });
    </script>
  </body>
</html>
