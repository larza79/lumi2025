<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Luminosity Festival Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Free CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }
      .priority-btn-group .btn-selected {
        background-color: #4f46e5;
        color: white;
      }
      .add-btn.added {
        background-color: #10b981;
        color: white;
        width: 34px;
        height: 34px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        transition: all 0.2s;
      }
      .add-btn.added:hover {
        transform: scale(1.05);
      }
      .concert-item.selected {
        background-color: #d1fae5; /* emerald-100 */
      }
      .concert-item.selected:hover {
        background-color: #a7f3d0; /* emerald-200 */
      }
      .concert-item.selected-conflict {
        background-color: #fef3c7; /* amber-100 */
      }
      .concert-item.selected-conflict:hover {
        background-color: #fde68a; /* amber-200 */
      }

      /* --- Dark Mode Styles --- */
      .dark body {
        background-color: #111827;
        color: #d1d5db;
      }
      .dark .card {
        background-color: #1f2937;
        border-color: #374151;
      }
      .dark .text-indigo-600 {
        color: #818cf8;
      }
      .dark .text-gray-600 {
        color: #9ca3af;
      }
      .dark .text-gray-500 {
        color: #6b7280;
      }
      .dark .border-b {
        border-color: #374151;
      }
      .dark .concert-item:hover {
        background-color: #374151;
      }
      .dark .concert-item.selected {
        background-color: #064e3b;
      }
      .dark .concert-item.selected:hover {
        background-color: #047857;
      }
      .dark .concert-item.selected-conflict {
        background-color: #78350f;
      } /* amber-800 */
      .dark .concert-item.selected-conflict:hover {
        background-color: #92400e;
      } /* amber-900 */
      .dark .day-header,
      .dark .itinerary-day-header {
        background-color: #1f2937;
      }
      .dark .priority-btn {
        background-color: #374151;
        border-color: #4b5563;
        color: #d1d5db;
      }
      .dark .priority-btn.btn-selected {
        background-color: #6366f1;
        color: white;
      }
      .dark .bg-green-100 {
        background-color: #042f2e;
      }
      .dark .text-green-800 {
        color: #6ee7b7;
      }
      .dark .text-green-700 {
        color: #a7f3d0;
      }
      .dark .border-green-500 {
        border-color: #10b981;
      }
      .dark .bg-yellow-100 {
        background-color: #422006;
      }
      .dark .text-yellow-800 {
        color: #fcd34d;
      }
      .dark .text-yellow-700 {
        color: #fde68a;
      }
      .dark .border-yellow-500 {
        border-color: #f59e0b;
      }
      .dark .hover\:bg-yellow-200:hover {
        background-color: #78350f;
      }
      .dark .bg-gray-50 {
        background-color: #374151;
      }
      .dark input[type="text"],
      .dark input[type="checkbox"] {
        background-color: #1f2937;
        border-color: #4b5563;
      }
      .dark input[type="checkbox"]:checked {
        background-color: #4f46e5;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
      <header class="relative text-center mb-8">
        <h1 class="text-4xl sm:text-5xl font-bold text-indigo-600">
          Luminosity Beach Festival 2025
        </h1>
        <p class="mt-2 text-lg text-gray-600">Your Personal Concert Planner</p>
        <button
          id="theme-toggle"
          class="absolute top-0 right-0 p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none"
        >
          <i id="theme-icon-light" class="fa-solid fa-sun fa-lg"></i>
          <i id="theme-icon-dark" class="fa-solid fa-moon fa-lg hidden"></i>
        </button>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Concert Selection Column -->
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg card">
          <h2 class="text-2xl font-semibold mb-4 border-b pb-2">
            Select Your Concerts
          </h2>

          <!-- Filter Section -->
          <div
            id="filter-container"
            class="mb-6 p-4 border rounded-lg bg-gray-50"
          >
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label
                  for="artist-search"
                  class="block text-sm font-medium mb-1"
                  >Search Artist</label
                >
                <input
                  type="text"
                  id="artist-search"
                  placeholder="e.g. Ferry Corsten"
                  class="w-full p-2 border rounded-md"
                />
              </div>
              <div class="flex items-end">
                <button
                  id="reset-filters-btn"
                  class="w-full md:w-auto bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white"
                >
                  Reset Filters
                </button>
              </div>
            </div>
            <div class="mt-4">
              <h4 class="font-medium mb-2">Filter by Day</h4>
              <div id="day-filters" class="flex flex-wrap gap-x-4 gap-y-2">
                <!-- Day checkboxes will be injected here -->
              </div>
            </div>
            <div class="mt-4">
              <h4 class="font-medium mb-2">Filter by Stage</h4>
              <div id="stage-filters" class="flex flex-wrap gap-x-4 gap-y-2">
                <!-- Stage checkboxes will be injected here -->
              </div>
            </div>
          </div>

          <div id="concert-list"></div>
        </div>

        <!-- Itinerary Column -->
        <div class="lg:col-span-1">
          <div class="sticky top-8 bg-white p-6 rounded-2xl shadow-lg card">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">
              Your Itinerary
            </h2>
            <div id="itinerary-list" class="space-y-4"></div>
            <button
              id="clear-plan-btn"
              class="mt-6 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105 hidden"
            >
              Clear Plan
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let concertData = [
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "MAINSTAGE BEACH",
          startTime: "12:00",
          endTime: "13:00",
          artist: "SPARK&SHADE",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "MAINSTAGE BEACH",
          startTime: "13:00",
          endTime: "14:00",
          artist: "SØNIN",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "MAINSTAGE BEACH",
          startTime: "14:00",
          endTime: "15:00",
          artist: "NITROUS OXIDE",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "MAINSTAGE BEACH",
          startTime: "15:00",
          endTime: "16:00",
          artist: "SIMON O'SHINE",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "MAINSTAGE BEACH",
          startTime: "16:00",
          endTime: "17:00",
          artist: "ASTEROID",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "MAINSTAGE BEACH",
          startTime: "17:00",
          endTime: "18:00",
          artist: "PAUL DENTON",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "MAINSTAGE BEACH",
          startTime: "18:00",
          endTime: "19:15",
          artist: "JORDAN SUCKLEY",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "MAINSTAGE BEACH",
          startTime: "19:15",
          endTime: "20:30",
          artist: "ALTI",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "MAINSTAGE BEACH",
          startTime: "20:30",
          endTime: "21:45",
          artist: "GARETH EMERY (HARD SET",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "MAINSTAGE BEACH",
          startTime: "21:45",
          endTime: "23:00",
          artist: "MARK SHERRY",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "SUNSET BEACH",
          startTime: "12:00",
          endTime: "13:15",
          artist: "SINFUL BIZ",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "SUNSET BEACH",
          startTime: "13:15",
          endTime: "14:30",
          artist: "DARREN TATE",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "SUNSET BEACH",
          startTime: "14:30",
          endTime: "15:45",
          artist: "RONSKI SPEED",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "SUNSET BEACH",
          startTime: "15:45",
          endTime: "17:00",
          artist: "KYAU & ALBERT",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "SUNSET BEACH",
          startTime: "17:00",
          endTime: "18:00",
          artist: "GENIX",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "SUNSET BEACH",
          startTime: "18:00",
          endTime: "19:00",
          artist: "LIAM WILSON",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "SUNSET BEACH",
          startTime: "19:00",
          endTime: "20:00",
          artist: "ARTENTO DIVINI",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "SUNSET BEACH",
          startTime: "20:00",
          endTime: "21:00",
          artist: "ALLEN WATTS",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "SUNSET BEACH",
          startTime: "21:00",
          endTime: "22:00",
          artist: "METTA & GLYDE",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "SUNSET BEACH",
          startTime: "22:00",
          endTime: "23:00",
          artist: "SAM JONES",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "BEACHCLUB BERNIES",
          startTime: "13:00",
          endTime: "14:30",
          artist: "TEMPLE ONE",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "BEACHCLUB BERNIES",
          startTime: "14:30",
          endTime: "15:45",
          artist: "ANDREA RIBECA",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "BEACHCLUB BERNIES",
          startTime: "15:45",
          endTime: "17:00",
          artist: "DANIEL KANDI",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "BEACHCLUB BERNIES",
          startTime: "17:00",
          endTime: "18:15",
          artist: "STEVE ALLEN",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "BEACHCLUB BERNIES",
          startTime: "18:15",
          endTime: "19:30",
          artist: "AHMED ROMEL",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "BEACHCLUB BERNIES",
          startTime: "19:30",
          endTime: "20:45",
          artist: "FERRY TAYLE & TONKS PRES. MIRAGE (VINYL SE",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "BEACHCLUB BERNIES",
          startTime: "20:45",
          endTime: "22:00",
          artist: "COLD BLUE",
        },
        {
          day: "Thursday",
          date: "2025-06-26",
          stage: "BEACHCLUB BERNIES",
          startTime: "22:00",
          endTime: "23:00",
          artist: "SIGNUM",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "MAINSTAGE BEACH",
          startTime: "12:00",
          endTime: "13:00",
          artist: "DYLHEN",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "MAINSTAGE BEACH",
          startTime: "13:00",
          endTime: "14:00",
          artist: "LEENA PUNKS",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "MAINSTAGE BEACH",
          startTime: "14:00",
          endTime: "15:00",
          artist: "PUSH",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "MAINSTAGE BEACH",
          startTime: "15:00",
          endTime: "16:00",
          artist: "ΚΑΙ TRACID",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "MAINSTAGE BEACH",
          startTime: "16:00",
          endTime: "17:00",
          artist: "AMBER BROOS",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "MAINSTAGE BEACH",
          startTime: "17:00",
          endTime: "18:00",
          artist: "BILLY GILLIES",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "MAINSTAGE BEACH",
          startTime: "18:00",
          endTime: "19:15",
          artist: "SPACE 92",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "MAINSTAGE BEACH",
          startTime: "19:15",
          endTime: "20:30",
          artist: "VINIVICI",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "MAINSTAGE BEACH",
          startTime: "20:30",
          endTime: "21:45",
          artist: "BEN NICKY PRES. EMOTIONAL HAVOC",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "MAINSTAGE BEACH",
          startTime: "21:45",
          endTime: "23:00",
          artist: "MADDIX",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "SUNSET BEACH",
          startTime: "12:00",
          endTime: "13:00",
          artist: "SIMON GREGORY",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "SUNSET BEACH",
          startTime: "13:00",
          endTime: "14:30",
          artist: "PAUL SKELTON",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "SUNSET BEACH",
          startTime: "14:00",
          endTime: "15:00",
          artist: "FACTORIA",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "SUNSET BEACH",
          startTime: "15:00",
          endTime: "18:00",
          artist: "ANDY MOOR (PRODUCER SET)",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "SUNSET BEACH",
          startTime: "16:00",
          endTime: "17:00",
          artist: "PAUL WEBSTER",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "SUNSET BEACH",
          startTime: "17:00",
          endTime: "18:00",
          artist: "SANDER VAN DOORN",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "SUNSET BEACH",
          startTime: "18:00",
          endTime: "19:00",
          artist: "WILL REES",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "SUNSET BEACH",
          startTime: "19:00",
          endTime: "20:00",
          artist: "GREG DOWNEY",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "SUNSET BEACH",
          startTime: "20:00",
          endTime: "21:00",
          artist: "SEAN TYAS",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "SUNSET BEACH",
          startTime: "21:00",
          endTime: "23:00",
          artist: "JOHN ASKEW B2B SIMON PATTERSON",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "BEACHCLUB BERNIES - HOSTED BY IN TRANCE WE TRUST",
          startTime: "12:00",
          endTime: "13:00",
          artist: "CLAUS BACKSLASH",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "BEACHCLUB BERNIES - HOSTED BY IN TRANCE WE TRUST",
          startTime: "13:00",
          endTime: "14:00",
          artist: "RALPHIE B & FRANK WAANDERS PRES. COLLIDE1",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "BEACHCLUB BERNIES - HOSTED BY IN TRANCE WE TRUST",
          startTime: "14:00",
          endTime: "15:00",
          artist: "DIMENSION",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "BEACHCLUB BERNIES - HOSTED BY IN TRANCE WE TRUST",
          startTime: "15:00",
          endTime: "16:00",
          artist: "MISJA HELSLOOT",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "BEACHCLUB BERNIES - HOSTED BY IN TRANCE WE TRUST",
          startTime: "16:00",
          endTime: "17:00",
          artist: "STONEFACE & TERMINAL",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "BEACHCLUB BERNIES - HOSTED BY IN TRANCE WE TRUST",
          startTime: "17:00",
          endTime: "18:15",
          artist: "JOHAN GIELEN",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "BEACHCLUB BERNIES - HOSTED BY IN TRANCE WE TRUST",
          startTime: "18:15",
          endTime: "19:30",
          artist: "MARIA HEALY",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "BEACHCLUB BERNIES - HOSTED BY IN TRANCE WE TRUST",
          startTime: "19:30",
          endTime: "20:45",
          artist: "RICHARD DURAND",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "BEACHCLUB BERNIES - HOSTED BY IN TRANCE WE TRUST",
          startTime: "20:45",
          endTime: "22:00",
          artist: "SNEJDER",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "BEACHCLUB BERNIES - HOSTED BY IN TRANCE WE TRUST",
          startTime: "22:00",
          endTime: "23:00",
          artist: "RAM",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "THIS IS TRANCE!",
          startTime: "13:00",
          endTime: "14:15",
          artist: "FUENKA",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "THIS IS TRANCE!",
          startTime: "14:15",
          endTime: "15:30",
          artist: "DIGITAL DRIFT",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "THIS IS TRANCE!",
          startTime: "15:30",
          endTime: "16:45",
          artist: "45C-SYSTEMS",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "THIS IS TRANCE!",
          startTime: "16:45",
          endTime: "18:00",
          artist: "DARREN PORTER",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "THIS IS TRANCE!",
          startTime: "18:00",
          endTime: "19:15",
          artist: "ADAM ELLIS",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "THIS IS TRANCE!",
          startTime: "19:15",
          endTime: "20:30",
          artist: "KINETICA",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "THIS IS TRANCE!",
          startTime: "20:30",
          endTime: "21:45",
          artist: "ΤOYAX",
        },
        {
          day: "Friday",
          date: "2025-06-27",
          stage: "THIS IS TRANCE!",
          startTime: "21:45",
          endTime: "23:00",
          artist: "EDELE ANDAYA",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "MAINSTAGE BEACH",
          startTime: "12:00",
          endTime: "13:15",
          artist: "MIROMAR",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "MAINSTAGE BEACH",
          startTime: "13:15",
          endTime: "14:30",
          artist: "ESTIVA",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "MAINSTAGE BEACH",
          startTime: "14:30",
          endTime: "15:45",
          artist: "DOSEM",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "MAINSTAGE BEACH",
          startTime: "15:45",
          endTime: "17:00",
          artist: "DAXSON",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "MAINSTAGE BEACH",
          startTime: "17:00",
          endTime: "18:30",
          artist: "MARKUS SCHULZ",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "MAINSTAGE BEACH",
          startTime: "18:30",
          endTime: "20:00",
          artist: "JOHN O'CALLAGHAN",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "MAINSTAGE BEACH",
          startTime: "20:00",
          endTime: "21:30",
          artist: "PAUL VAN DYK",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "MAINSTAGE BEACH",
          startTime: "21:30",
          endTime: "23:00",
          artist: "BRYAN KEARNEY",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "SUNSET BEACH TRANCE CLASSICS",
          startTime: "12:00",
          endTime: "13:00",
          artist: "THE BLIZZARD",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "SUNSET BEACH TRANCE CLASSICS",
          startTime: "13:00",
          endTime: "14:15",
          artist: "TRANCE WAX",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "SUNSET BEACH TRANCE CLASSICS",
          startTime: "14:15",
          endTime: "15:30",
          artist: "PUSH",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "SUNSET BEACH TRANCE CLASSICS",
          startTime: "16:45",
          endTime: "18:00",
          artist: "GABRIEL & DRESDEN",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "SUNSET BEACH TRANCE CLASSICS",
          startTime: "16:45",
          endTime: "18:00",
          artist: "RUBEN DE RONDE PRES. NRG2000",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "SUNSET BEACH TRANCE CLASSICS",
          startTime: "16:45",
          endTime: "18:00",
          artist: "SUPERSTRINGS",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "SUNSET BEACH TRANCE CLASSICS",
          startTime: "19:10",
          endTime: "20:20",
          artist: "SANDER VAN DOORN",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "SUNSET BEACH TRANCE CLASSICS",
          startTime: "20:20",
          endTime: "21:30",
          artist: "MARCOV",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "SUNSET BEACH TRANCE CLASSICS",
          startTime: "21:30",
          endTime: "23:00",
          artist: "SCOT PROJECT & JORDAN SUCKLEY",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "BEACHCLUB BERNIES - HOSTED BY INFINITY",
          startTime: "12:00",
          endTime: "13:15",
          artist: "TALEE",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "BEACHCLUB BERNIES - HOSTED BY INFINITY",
          startTime: "13:15",
          endTime: "14:30",
          artist: "MODEA",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "BEACHCLUB BERNIES - HOSTED BY INFINITY",
          startTime: "14:30",
          endTime: "15:45",
          artist: "CORREN CAVINI",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "BEACHCLUB BERNIES - HOSTED BY INFINITY",
          startTime: "15:45",
          endTime: "17:00",
          artist: "BLR",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "BEACHCLUB BERNIES - HOSTED BY INFINITY",
          startTime: "17:00",
          endTime: "19:00",
          artist: "PAUL OAKENFOLD",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "BEACHCLUB BERNIES - HOSTED BY INFINITY",
          startTime: "19:00",
          endTime: "20:20",
          artist: "JOHN 00 FLEMING",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "BEACHCLUB BERNIES - HOSTED BY INFINITY",
          startTime: "20:20",
          endTime: "21:40",
          artist: "DAVID FORBES",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "BEACHCLUB BERNIES - HOSTED BY INFINITY",
          startTime: "21:40",
          endTime: "23:00",
          artist: "MARK SHERRY PRES. DARK SHERRY",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "THIS IS TRANCE!",
          startTime: "12:00",
          endTime: "13:30",
          artist: "ODETTE HAYAS",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "THIS IS TRANCE!",
          startTime: "13:30",
          endTime: "15:00",
          artist: "SUNNY LAX",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "THIS IS TRANCE!",
          startTime: "15:00",
          endTime: "16:20",
          artist: "THE BLIZZARD",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "THIS IS TRANCE!",
          startTime: "16:20",
          endTime: "17:40",
          artist: "DANIEL SKYVER",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "THIS IS TRANCE!",
          startTime: "17:40",
          endTime: "19:00",
          artist: "AEON SHIFT",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "THIS IS TRANCE!",
          startTime: "19:00",
          endTime: "20:20",
          artist: "DNA",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "THIS IS TRANCE!",
          startTime: "20:20",
          endTime: "21:40",
          artist: "BRENDAN BARTELS",
        },
        {
          day: "Saturday",
          date: "2025-06-28",
          stage: "THIS IS TRANCE!",
          startTime: "21:40",
          endTime: "23:00",
          artist: "RENEGADE SYSTEM",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "MAINSTAGE BEACH",
          startTime: "12:00",
          endTime: "13:15",
          artist: "ALEX WRIGHT",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "MAINSTAGE BEACH",
          startTime: "13:15",
          endTime: "14:30",
          artist: "ORKIDEA",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "MAINSTAGE BEACH",
          startTime: "14:30",
          endTime: "15:45",
          artist: "THE THRILLSEEKERS",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "MAINSTAGE BEACH",
          startTime: "15:45",
          endTime: "17:00",
          artist: "CRAIG CONNELLY",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "MAINSTAGE BEACH",
          startTime: "17:00",
          endTime: "18:15",
          artist: "BEN GOLD",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "MAINSTAGE BEACH",
          startTime: "18:15",
          endTime: "19:45",
          artist: "GIUSEPPE OTTAVIANI B2B NIFRA",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "MAINSTAGE BEACH",
          startTime: "19:45",
          endTime: "21:15",
          artist: "ALY & FILA",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "MAINSTAGE BEACH",
          startTime: "21:15",
          endTime: "23:00",
          artist: "FERRY CORSTEN",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "SUNSET RAVERS",
          startTime: "12:00",
          endTime: "13:00",
          artist: "JAMIE WALKER",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "SUNSET RAVERS",
          startTime: "13:00",
          endTime: "14:00",
          artist: "TYLER JACK",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "SUNSET RAVERS",
          startTime: "14:00",
          endTime: "15:00",
          artist: "SYMMETRIK",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "SUNSET RAVERS",
          startTime: "15:00",
          endTime: "16:00",
          artist: "SHUGZ",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "SUNSET RAVERS",
          startTime: "16:00",
          endTime: "17:00",
          artist: "VE/RA",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "SUNSET RAVERS",
          startTime: "17:00",
          endTime: "18:20",
          artist: "MAURO PICOTTO",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "SUNSET RAVERS",
          startTime: "18:20",
          endTime: "19:40",
          artist: "WILL ATKINSON",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "SUNSET RAVERS",
          startTime: "19:40",
          endTime: "21:00",
          artist: "HANNAH LAING",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "SUNSET RAVERS",
          startTime: "21:00",
          endTime: "22:00",
          artist: "THE ROCKETMAN",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "SUNSET RAVERS",
          startTime: "22:00",
          endTime: "23:00",
          artist: "JOHN ASKEW (NOTHING BUT ROCKETS SET)",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "12:00",
          endTime: "13:00",
          artist: "DANIEL SKYVER (PROGRESSIVE CLASSICS)",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "12:00",
          endTime: "13:00",
          artist: "SAM MITCHAM (VINYL SET)",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "14:00",
          endTime: "15:00",
          artist: "BEN LOST",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "15:00",
          endTime: "16:00",
          artist: "OLIVER LIEB",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "16:00",
          endTime: "17:00",
          artist: "MR SAM",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "17:00",
          endTime: "18:00",
          artist: "MATT DAREY",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "18:00",
          endTime: "19:00",
          artist: "THE SPACE BROTHERS",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "19:00",
          endTime: "20:00",
          artist: "JUDGE JULES",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "20:00",
          endTime: "21:00",
          artist: "FRED BAKER",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "21:00",
          endTime: "22:00",
          artist: "DJ QUICKSILVER",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "BEACHCLUB BERNIES TRANCE CLASSICS",
          startTime: "22:00",
          endTime: "23:00",
          artist: "FACTOR B (BACK TO THE FUTURE SETS",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "THIS IS TRANCE!",
          startTime: "13:00",
          endTime: "14:15",
          artist: "MAYWAVE",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "THIS IS TRANCE!",
          startTime: "14:15",
          endTime: "15:30",
          artist: "PETER STEELE",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "THIS IS TRANCE!",
          startTime: "15:30",
          endTime: "16:45",
          artist: "DOPPENBERG",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "THIS IS TRANCE!",
          startTime: "16:45",
          endTime: "18:00",
          artist: "ENIGMA STATE",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "THIS IS TRANCE!",
          startTime: "18:00",
          endTime: "19:15",
          artist: "OGRAVITY",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "THIS IS TRANCE!",
          startTime: "19:15",
          endTime: "20:30",
          artist: "TASSO",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "THIS IS TRANCE!",
          startTime: "20:30",
          endTime: "21:45",
          artist: "MATT BUKOVSKI",
        },
        {
          day: "Sunday",
          date: "2025-06-29",
          stage: "THIS IS TRANCE!",
          startTime: "21:45",
          endTime: "23:00",
          artist: "ΝΙKOLAUSS",
        },
      ];

      // --- DATA PRE-PROCESSING ---
      // Add a unique ID to each concert and consolidate stages
      concertData = concertData.map((concert, index) => {
        let stage = concert.stage;
        let notes = concert.notes || "";

        if (stage.includes("Beachclub Bernies")) {
          const match = stage.match(/\(([^)]+)\)/); // Find text in parentheses
          if (match) {
            const existingNotes = concert.notes ? `${concert.notes} ` : "";
            notes = `${existingNotes}${match[1]}`.trim();
          }
          stage = "Beachclub Bernies";
        } else if (stage.includes("Sunset")) {
          let themeNote = "";
          if (stage.includes("Classics")) {
            themeNote = "Classics";
          } else if (stage.includes("Powers")) {
            themeNote = "Powers";
          }

          if (themeNote) {
            const existingNotes = concert.notes ? `${concert.notes} ` : "";
            notes = `${existingNotes}${themeNote}`.trim();
          }
          stage = "Sunset Beach";
        }

        return {
          ...concert,
          id: `concert-${index}`, // Assign a stable, unique ID
          stage: stage,
          notes: notes,
        };
      });

      document.addEventListener("DOMContentLoaded", () => {
        // --- Elements ---
        const concertListContainer = document.getElementById("concert-list");
        const itineraryListContainer =
          document.getElementById("itinerary-list");
        const clearPlanBtn = document.getElementById("clear-plan-btn");
        const themeToggleBtn = document.getElementById("theme-toggle");
        const lightIcon = document.getElementById("theme-icon-light");
        const darkIcon = document.getElementById("theme-icon-dark");
        const htmlEl = document.documentElement;

        let userSelections = [];
        let winnerIds = new Set();

        // --- Theme Management ---
        const applyTheme = (theme) => {
          htmlEl.classList.toggle("dark", theme === "dark");
          darkIcon.classList.toggle("hidden", theme !== "dark");
          lightIcon.classList.toggle("hidden", theme === "dark");
        };
        const toggleTheme = () => {
          const newTheme = htmlEl.classList.contains("dark") ? "light" : "dark";
          localStorage.setItem("theme", newTheme);
          applyTheme(newTheme);
        };

        // --- LocalStorage ---
        const saveSelections = () =>
          localStorage.setItem(
            "festivalPlannerSelections",
            JSON.stringify(userSelections)
          );
        const loadSelections = () => {
          const savedData = localStorage.getItem("festivalPlannerSelections");
          if (savedData) userSelections = JSON.parse(savedData);
        };

        // --- Helpers ---
        const timeToMinutes = (time) => {
          const [hours, minutes] = time.split(":").map(Number);
          return hours * 60 + minutes;
        };
        const getDuration = (start, end) =>
          timeToMinutes(end) - timeToMinutes(start);
        const checkConflict = (concertA, concertB) => {
          if (!concertA || !concertB) return false;
          const startA = timeToMinutes(concertA.startTime);
          const endA = timeToMinutes(concertA.endTime);
          const startB = timeToMinutes(concertB.startTime);
          const endB = timeToMinutes(concertB.endTime);
          const overlap = Math.max(
            0,
            Math.min(endA, endB) - Math.max(startA, startB)
          );
          return overlap > 15;
        };

        // --- Main UI Refresh Logic ---
        const refreshAll = () => {
          updateWinners();
          applyFiltersAndRender();
          updateItinerary();
          saveSelections();
        };

        // --- Data Processing & Filtering ---
        const updateWinners = () => {
          const sortedSelections = [...userSelections].sort((a, b) => {
            if (a.priority !== b.priority) return a.priority - b.priority;
            return timeToMinutes(a.startTime) - timeToMinutes(b.startTime);
          });

          const winners = [];
          sortedSelections.forEach((concert) => {
            if (!winners.some((winner) => checkConflict(concert, winner))) {
              winners.push(concert);
            }
          });
          winnerIds = new Set(winners.map((w) => w.id));
        };

        const getUniqueValues = (key) =>
          [...new Set(concertData.map((item) => item[key]))].sort();

        const applyFiltersAndRender = () => {
          const artistSearch = document
            .getElementById("artist-search")
            .value.toLowerCase();
          const selectedDays = [
            ...document.querySelectorAll("#day-filters input:checked"),
          ].map((el) => el.value);
          const selectedStages = [
            ...document.querySelectorAll("#stage-filters input:checked"),
          ].map((el) => el.value);

          const filteredConcerts = concertData.filter((concert) => {
            const artistMatch = concert.artist
              .toLowerCase()
              .includes(artistSearch);
            const dayMatch =
              selectedDays.length === 0 || selectedDays.includes(concert.day);
            const stageMatch =
              selectedStages.length === 0 ||
              selectedStages.includes(concert.stage);
            return artistMatch && dayMatch && stageMatch;
          });

          renderFilteredConcerts(filteredConcerts);
        };

        // --- Render Functions ---
        const renderFilteredConcerts = (concertsToRender) => {
          concertListContainer.innerHTML = "";
          if (concertsToRender.length === 0) {
            concertListContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">No concerts match your filters.</p>`;
            return;
          }

          const checkMarkSVG = `<i class="fa-solid fa-check"></i>`;

          const concertsByDay = concertsToRender.reduce((acc, concert) => {
            (acc[concert.day] = acc[concert.day] || []).push(concert);
            return acc;
          }, {});

          Object.keys(concertsByDay)
            .sort(
              (a, b) =>
                ["Thursday", "Friday", "Saturday", "Sunday"].indexOf(a) -
                ["Thursday", "Friday", "Saturday", "Sunday"].indexOf(b)
            )
            .forEach((day) => {
              const dayHeader = document.createElement("h3");
              dayHeader.className =
                "day-header text-xl font-bold mt-6 mb-3 bg-gray-200 p-2 rounded-md";
              dayHeader.textContent = `${day}, ${concertsByDay[day][0].date}`;
              concertListContainer.appendChild(dayHeader);

              concertsByDay[day].forEach((concert) => {
                const concertEl = document.createElement("div");
                concertEl.className =
                  "concert-item flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 border-b hover:bg-gray-50";
                const existingSelection = userSelections.find(
                  (s) => s.id === concert.id
                );
                const isAdded = !!existingSelection;

                concertEl.classList.remove("selected", "selected-conflict");
                if (isAdded) {
                  if (winnerIds.has(concert.id)) {
                    concertEl.classList.add("selected");
                  } else {
                    concertEl.classList.add("selected-conflict");
                  }
                }

                const buttonContent = isAdded ? checkMarkSVG : "Add";
                const buttonClasses = isAdded
                  ? "add-btn added"
                  : "add-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-4 rounded-md";

                concertEl.innerHTML = `
                            <div class="flex-grow mb-2 sm:mb-0">
                                <p class="font-semibold text-lg">${
                                  concert.artist
                                } ${
                  concert.notes
                    ? `<span class="text-sm text-gray-500 font-normal">${concert.notes}</span>`
                    : ""
                }</p>
                                <p class="text-sm text-gray-600">${
                                  concert.startTime
                                } - ${concert.endTime} (${getDuration(
                  concert.startTime,
                  concert.endTime
                )} mins)</p>
                                <p class="text-sm text-indigo-500 font-medium">${
                                  concert.stage
                                }</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="priority-btn-group flex" data-id="${
                                  concert.id
                                }">
                                    <button class="priority-btn text-xs font-semibold py-1 px-3 rounded-l-md border border-gray-300 bg-white" data-priority="1">P1</button><button class="priority-btn text-xs font-semibold py-1 px-3 border-t border-b border-gray-300 bg-white" data-priority="2">P2</button><button class="priority-btn text-xs font-semibold py-1 px-3 rounded-r-md border border-gray-300 bg-white" data-priority="3">P3</button>
                                </div>
                                <button class="${buttonClasses}" data-id="${
                  concert.id
                }">${buttonContent}</button>
                            </div>`;
                concertListContainer.appendChild(concertEl);
                if (isAdded) {
                  const priorityButton = concertEl.querySelector(
                    `.priority-btn[data-priority="${existingSelection.priority}"]`
                  );
                  if (priorityButton)
                    priorityButton.classList.add("btn-selected");
                }
              });
            });
        };

        const updateItinerary = () => {
          if (userSelections.length === 0) {
            itineraryListContainer.innerHTML =
              '<p class="text-gray-500">Your planned concerts will appear here. Add concerts from the left to get started!</p>';
            clearPlanBtn.classList.add("hidden");
            return;
          }

          clearPlanBtn.classList.remove("hidden");

          const winners = [...userSelections].filter((s) =>
            winnerIds.has(s.id)
          );
          const itineraryByDay = {};
          winners
            .sort(
              (a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime)
            )
            .forEach((winner) => {
              const day = winner.day;
              if (!itineraryByDay[day]) itineraryByDay[day] = [];
              const conflicts = userSelections.filter(
                (c) => c.id !== winner.id && checkConflict(c, winner)
              );
              itineraryByDay[day].push({
                concert: winner,
                conflicts: conflicts,
              });
            });

          renderItineraryUI(itineraryByDay);
        };

        const renderItineraryUI = (itineraryByDay) => {
          itineraryListContainer.innerHTML = "";
          const removeIconSVG = `<i class="fa-solid fa-xmark"></i>`;

          if (
            Object.keys(itineraryByDay).length === 0 &&
            userSelections.length > 0
          ) {
            itineraryListContainer.innerHTML =
              '<p class="text-gray-500 font-semibold">All your selections might have conflicts. Try changing priorities.</p>';
            return;
          } else if (userSelections.length === 0) {
            itineraryListContainer.innerHTML =
              '<p class="text-gray-500">Your planned concerts will appear here. Add concerts from the left to get started!</p>';
            return;
          }

          Object.keys(itineraryByDay)
            .sort(
              (a, b) =>
                ["Thursday", "Friday", "Saturday", "Sunday"].indexOf(a) -
                ["Thursday", "Friday", "Saturday", "Sunday"].indexOf(b)
            )
            .forEach((day) => {
              const dayHeader = document.createElement("h3");
              dayHeader.className =
                "itinerary-day-header text-lg font-bold mt-4 mb-2 bg-gray-200 p-2 rounded-md";
              dayHeader.textContent = day;
              itineraryListContainer.appendChild(dayHeader);

              itineraryByDay[day].forEach((item) => {
                const { concert, conflicts } = item;
                const itemEl = document.createElement("div");
                itemEl.className = "itinerary-item mb-2";

                itemEl.innerHTML = `
                            <div class="p-3 bg-green-100 border-l-4 border-green-500 rounded-r-lg">
                                <div class="flex justify-between items-start">
                                    <div class="concert-swap-item cursor-pointer flex-grow" data-main-id="${
                                      concert.id
                                    }" data-conflict-id="${concert.id}">
                                        <p class="font-bold text-green-800">${
                                          concert.artist
                                        } (P${concert.priority})</p>
                                        <p class="text-sm text-green-700">${
                                          concert.startTime
                                        } - ${concert.endTime} (${getDuration(
                  concert.startTime,
                  concert.endTime
                )} mins)</p>
                                        <p class="text-sm text-green-700 font-medium">@ ${
                                          concert.stage
                                        }</p>
                                    </div>
                                    <button title="Remove concert" class="remove-item-btn p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-100 dark:text-gray-500 dark:hover:text-red-400 dark:hover:bg-gray-700" data-id="${
                                      concert.id
                                    }">
                                        ${removeIconSVG}
                                    </button>
                                </div>
                            </div>
                            <div class="conflict-container pl-5" id="conflict-list-${
                              concert.id
                            }"></div>
                        `;
                itineraryListContainer.appendChild(itemEl);

                if (conflicts.length > 0) {
                  const conflictContainer = itemEl.querySelector(
                    `#conflict-list-${concert.id}`
                  );
                  populateConflictList(
                    conflictContainer,
                    conflicts,
                    concert.id
                  );
                }
              });
            });
        };

        const populateConflictList = (container, conflicts, mainConcertId) => {
          const removeIconSVG = `<i class="fa-solid fa-xmark"></i>`;
          container.innerHTML = "";
          conflicts.forEach((conflict) => {
            const conflictEl = document.createElement("div");
            conflictEl.className =
              "p-3 mt-2 bg-yellow-100 border-l-4 border-yellow-500 rounded-r-lg";

            conflictEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="conflict-swap-item cursor-pointer flex-grow" data-main-id="${mainConcertId}" data-conflict-id="${conflict.id}">
                                <p class="font-bold text-yellow-800">${conflict.artist} (P${conflict.priority})</p>
                                <p class="text-sm text-yellow-700">${conflict.startTime} - ${conflict.endTime} @ ${conflict.stage}</p>
                                <p class="text-sm text-yellow-700">Click to swap</p>
                            </div>
                            <button title="Remove conflict" class="remove-conflict-btn p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-100 dark:text-gray-500 dark:hover:text-red-400 dark:hover:bg-gray-700" data-id="${conflict.id}">
                                ${removeIconSVG}
                            </button>
                        </div>
                    `;
            container.appendChild(conflictEl);
          });
        };

        // --- Event Handlers ---
        const handleAddClick = (e) => {
          const button = e.target.closest(".add-btn");
          if (!button) return;

          const concertId = button.dataset.id;
          const concert = concertData.find((c) => c.id === concertId);
          const existingSelectionIndex = userSelections.findIndex(
            (s) => s.id === concertId
          );

          if (existingSelectionIndex > -1) {
            userSelections.splice(existingSelectionIndex, 1);
          } else {
            const concertElement = button.closest(".concert-item");
            const selectedPriorityBtn = concertElement.querySelector(
              ".priority-btn-group .btn-selected"
            );
            let assignedPriority;

            if (selectedPriorityBtn) {
              assignedPriority = parseInt(
                selectedPriorityBtn.dataset.priority,
                10
              );
              const concertToChange = {
                ...concert,
                priority: assignedPriority,
              };
              userSelections.forEach((selection) => {
                if (
                  checkConflict(selection, concertToChange) &&
                  selection.priority >= assignedPriority
                ) {
                  selection.priority = Math.min(3, assignedPriority + 1);
                }
              });
            } else {
              // Smart auto-priority logic
              let finalPriority = 1;
              if (
                userSelections.some(
                  (s) => checkConflict(s, concert) && s.priority === 1
                )
              ) {
                finalPriority = 2;
                if (
                  userSelections.some(
                    (s) =>
                      checkConflict(s, { ...concert, priority: 2 }) &&
                      s.priority <= 2
                  )
                ) {
                  finalPriority = 3;
                }
              }
              assignedPriority = finalPriority;
            }
            userSelections.push({ ...concert, priority: assignedPriority });
          }
          refreshAll();
        };

        const handlePriorityClick = (e) => {
          const button = e.target.closest(".priority-btn");
          if (!button) return;

          const priorityGroup = button.parentElement;
          const concertId = priorityGroup.dataset.id;
          const newPriority = parseInt(button.dataset.priority, 10);

          const selectionIndex = userSelections.findIndex(
            (s) => s.id === concertId
          );

          if (selectionIndex > -1) {
            const concertToChange = userSelections[selectionIndex];

            userSelections.forEach((selection) => {
              if (
                selection.id !== concertId &&
                checkConflict(selection, concertToChange) &&
                selection.priority >= newPriority
              ) {
                selection.priority = Math.min(3, newPriority + 1);
              }
            });
            userSelections[selectionIndex].priority = newPriority;

            refreshAll();
          } else {
            const allPriorityButtons =
              priorityGroup.querySelectorAll(".priority-btn");
            allPriorityButtons.forEach((btn) =>
              btn.classList.remove("btn-selected")
            );
            button.classList.add("btn-selected");
          }
        };

        const handleRemoveItem = (concertIdToRemove) => {
          const indexToRemove = userSelections.findIndex(
            (c) => c.id === concertIdToRemove
          );
          if (indexToRemove > -1) {
            userSelections.splice(indexToRemove, 1);
            refreshAll();
          }
        };

        const handleItineraryClick = (e) => {
          const removeItemBtn = e.target.closest(".remove-item-btn");
          if (removeItemBtn) {
            handleRemoveItem(removeItemBtn.dataset.id);
            return;
          }

          const removeConflictBtn = e.target.closest(".remove-conflict-btn");
          if (removeConflictBtn) {
            handleRemoveItem(removeConflictBtn.dataset.id);
            return;
          }

          const swapItem = e.target.closest(".conflict-swap-item");
          if (swapItem) {
            const mainId = swapItem.dataset.mainId;
            const conflictId = swapItem.dataset.conflictId;
            const mainConcertIndex = userSelections.findIndex(
              (c) => c.id === mainId
            );
            const conflictConcertIndex = userSelections.findIndex(
              (c) => c.id === conflictId
            );

            if (mainConcertIndex > -1 && conflictConcertIndex > -1) {
              const mainPriority = userSelections[mainConcertIndex].priority;
              userSelections[mainConcertIndex].priority =
                userSelections[conflictConcertIndex].priority;
              userSelections[conflictConcertIndex].priority = mainPriority;
              refreshAll();
            }
            return;
          }
        };

        const clearPlan = () => {
          userSelections = [];
          refreshAll();
        };

        const initializeFilters = () => {
          const dayFilterContainer = document.getElementById("day-filters");
          const stageFilterContainer = document.getElementById("stage-filters");
          const artistSearchInput = document.getElementById("artist-search");
          const resetBtn = document.getElementById("reset-filters-btn");

          const dayOrder = ["Thursday", "Friday", "Saturday", "Sunday"];
          const uniqueDays = getUniqueValues("day").sort(
            (a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b)
          );
          const uniqueStages = getUniqueValues("stage");

          uniqueDays.forEach((day) => {
            const checkboxDiv = document.createElement("div");
            checkboxDiv.className = "flex items-center";
            checkboxDiv.innerHTML = `<input id="day-${day}" value="${day}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="day-${day}" class="ml-2">${day}</label>`;
            dayFilterContainer.appendChild(checkboxDiv);
          });

          uniqueStages.forEach((stage) => {
            const checkboxDiv = document.createElement("div");
            checkboxDiv.className = "flex items-center";
            checkboxDiv.innerHTML = `<input id="stage-${stage}" value="${stage}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="stage-${stage}" class="ml-2">${stage}</label>`;
            stageFilterContainer.appendChild(checkboxDiv);
          });

          artistSearchInput.addEventListener("input", applyFiltersAndRender);
          dayFilterContainer.addEventListener("change", applyFiltersAndRender);
          stageFilterContainer.addEventListener(
            "change",
            applyFiltersAndRender
          );

          resetBtn.addEventListener("click", () => {
            artistSearchInput.value = "";
            document
              .querySelectorAll('#filter-container input[type="checkbox"]')
              .forEach((cb) => (cb.checked = false));
            applyFiltersAndRender();
          });
        };

        // --- Initialisation ---
        const initialTheme =
          localStorage.getItem("theme") ||
          (window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light");
        applyTheme(initialTheme);
        loadSelections();
        initializeFilters();
        refreshAll();

        // --- Event Listeners ---
        themeToggleBtn.addEventListener("click", toggleTheme);
        const concertListElement = document.getElementById("concert-list");
        concertListElement.addEventListener("click", (e) => {
          if (e.target.closest(".add-btn")) {
            handleAddClick(e);
          } else if (e.target.closest(".priority-btn")) {
            handlePriorityClick(e);
          }
        });
        itineraryListContainer.addEventListener("click", handleItineraryClick);
        clearPlanBtn.addEventListener("click", clearPlan);
      });
    </script>
  </body>
</html>
